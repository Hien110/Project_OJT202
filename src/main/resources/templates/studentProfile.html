<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css"
      rel="stylesheet"
    />
    <link rel="preload" href="/assets/images/68.jpg" as="image" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="/assets/js/headerNav.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/headerNav.css}" />
    <title>Thông tin tài khoản</title>
    <link
    rel="stylesheet"
    type="text/css"   
    th:href="@{/assets/css/studentProfile.css}"/>

</head>
<body>
    <div th:insert="~{headerNav :: header}"></div>
    <div th:insert="~{headerNav :: navStudent}"></div>
    
    <div class="container">
        <h1>Thông tin tài khoản</h1>
        <div class="profile-wrapper">
            <!-- Profile Info (Left) -->
            <div class="profile-info">
                <div th:if="${studentProfile != null}">
                    <p>Họ: <span th:text="${studentProfile.firstName}"></span></p>
                    <p>Tên: <span th:text="${studentProfile.lastName}"></span></p>
                    <p>Ngày sinh: <span th:text="${studentProfile.dob}"></span></p>
                    <p>Giới tính: <span th:text="${studentProfile.gender ? 'Nam' : 'Nữ'}"></span></p>
                    <p>Địa chỉ: <span th:text="${studentProfile.address}"></span></p>
                    <p>Số điện thoại: <span th:text="${studentProfile.phoneNumber}"></span></p>
                    <p>Email: <span th:text="${studentProfile.email}"></span></p>
                    <p>Năm nhập học: <span th:text="${studentProfile.yearOfAdmission}"></span></p>
                    <p>Năm học: <span th:text="${studentProfile.schoolYear}"></span></p>
                    <p>Mã chuyên ngành: <span th:text="${studentProfile.major?.majorID}"></span></p>
                    <p>Mã phụ huynh: <span th:text="${studentProfile.parent?.parentID}"></span></p>

                    <!-- Logout and Change Password Buttons -->
                    <div class="button-group">
                        <button onclick="window.location.href='/resetpassword'" class="btn btn-primary">Đổi mật khẩu</button>
                        <button onclick="window.location.href='/login'" class="btn btn-danger">Đăng xuất</button>              
                    </div>
                </div>
                <div th:if="${studentProfile == null}">
                    <p>Không tìm thấy thông tin sinh viên.</p>
                </div>
            </div>

<!-- Profile avatar -->
<div class="profile-avatar">
    <div>
        <!-- Hiển thị avatar hoặc ảnh mặc định nếu không có avatar -->
        <img id="avatarPreview"
             th:src="@{${studentProfile.avatar != null && studentProfile.avatar != '' ? studentProfile.avatar : '/assets/images/defaultAvatar.jpg'}}"
             class="avatar">
        <!-- Hiển thị ảnh tải lên khi chọn ảnh -->
        <img id="uploadedAvatar" src="" alt="Ảnh tải lên" class="avatar" style="display: none;">
    </div>
</div>

<!-- Nút chọn ảnh -->
<div class="file-upload">
    <label for="fileInput" class="btn btn-secondary">Chọn ảnh</label>
    <input type="file" id="fileInput" accept=".png, .jpg, .jpeg" style="display: none;" />
</div>

<!-- Hiển thị ảnh đã chọn và nút lưu -->
<div id="selectedImage" style="display:none;">
    <img id="imagePreview" style="max-width: 200px; margin-top: 20px;" />
    <button id="saveAvatar" class="btn btn-success" style="margin-top: 10px;">Lưu ảnh</button>
</div>
    
    <script>
   document.getElementById('fileInput').addEventListener('change', function (event) {
    const file = event.target.files[0]; // Lấy tệp được chọn
    if (file) {
        // Kiểm tra loại tệp (chỉ cho phép ảnh .jpg, .jpeg, .png)
        const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        if (validTypes.includes(file.type)) {
            const reader = new FileReader(); // Tạo FileReader để đọc tệp
            reader.onload = function (e) {
                // Ẩn ảnh mặc định
                document.getElementById('avatarPreview').style.display = 'none';
                // Hiển thị ảnh tải lên
                const uploadedAvatar = document.getElementById('uploadedAvatar');
                uploadedAvatar.src = e.target.result;
                uploadedAvatar.style.display = 'block';

                // Hiển thị ảnh đã chọn
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('selectedImage').style.display = 'block'; // Hiển thị khối ảnh đã chọn
            };
            reader.readAsDataURL(file); // Đọc tệp dưới dạng URL
        } else {
            alert('Chỉ cho phép tải lên ảnh .jpg, .jpeg hoặc .png.');
            document.getElementById('fileInput').value = ''; // Xóa tệp đã chọn
        }
    }
});

document.getElementById('saveAvatar').addEventListener('click', function() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0]; // Lấy tệp được chọn

    if (!file) {
        alert('Vui lòng chọn ảnh để tải lên.');
        return;
    }

    // Kiểm tra loại tệp (chỉ cho phép ảnh .jpg, .jpeg, .png)
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
    if (!validTypes.includes(file.type)) {
        alert('Chỉ cho phép tải lên ảnh .jpg, .jpeg hoặc .png.');
        return;
    }

    const formData = new FormData();
    formData.append('avatar', file);
    formData.append('studentID', 'DE170681'); // Cập nhật studentID thực tế

    fetch('/studentProfile/uploadAvatar', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Cập nhật ảnh thành công!');
            location.reload(); 
        } else {
            alert(data.message); // Hiển thị thông báo lỗi trả về từ server
        }
    })
    .catch(error => {
        alert('Có lỗi xảy ra!');
        console.error(error);
    });
});
    </script>
</body>
</html>
