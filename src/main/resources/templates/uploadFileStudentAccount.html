<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Tạo Tài Khoản Và Thông Tin Sinh Viên</title>
    <style>
      /* Modal CSS */
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        width: 400px;
        text-align: center;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .upload-area {
        width: 100%;
        height: 200px;
        border: 2px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        cursor: pointer;
      }

      .upload-area.dragging {
        border-color: #000;
        background-color: #f9f9f9;
      }

      .upload-area p {
        font-size: 18px;
        color: #555;
      }

      input[type="file"] {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      table,
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Tạo Tài Khoản Và Thông Tin Sinh Viên</h1>

    <!-- File Upload Section -->
    <form
      id="uploadForm"
      method="post"
      enctype="multipart/form-data"
      th:action="@{/uploadFileStudentAccountDetail}"
    >
      <div id="uploadArea" class="upload-area">
        <p>Kéo và thả tệp của bạn vào đây hoặc nhấp để chọn tệp</p>
      </div>
      <input type="file" name="file" id="fileInput" accept=".xlsx, .xls" />
    </form>

    <script>
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const form = document.getElementById("uploadForm");

      // Highlight the drop area when a file is being dragged over it
      ["dragenter", "dragover"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add("dragging");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove("dragging");
        });
      });

      // Handle the dropped file
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const files = e.dataTransfer.files;
        if (files.length) {
          fileInput.files = files; // Set the file to the input
          form.submit(); // Automatically submit the form after dropping the file
        }
      });

      // Allow clicking to open the file input
      uploadArea.addEventListener("click", () => fileInput.click());

      // Trigger form submit when a file is selected through the input
      fileInput.addEventListener("change", () => form.submit());
    </script>

    <!-- Hide the upload area after file is uploaded -->
    <script th:if="${fileUploaded}">
      document.addEventListener("DOMContentLoaded", function () {
        // Ẩn khu vực kéo thả sau khi tải file thành công
        const uploadArea = document.getElementById("uploadArea");
        if (uploadArea) {
          uploadArea.style.display = "none";
        }
      });
    </script>

    <!-- Display Student Data Section (this will be populated after the file upload) -->
    <!-- Display Student Data Section (Paginated) -->
    <div id="studentDataContainer" th:if="${studentProfiles != null}">
      <h2>Thông tin sinh viên</h2>
      <table id="studentTable">
        <thead>
          <tr>
            <th>STT</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>DOB</th>
            <th>Gender</th>
            <th>Address</th>
            <th>Student Phone</th>
            <th>Student Email</th>
            <th>Parent Name</th>
            <th>Parent Phone</th>
            <th>Parent Email</th>
            <th>Major ID</th>
            <th>Year of Submission</th>
            <th>Relationship</th>
            <th>School Year</th>
            <th>Account ID Student</th>
          </tr>
        </thead>
        <tbody id="studentTableBody">
          <tr th:each="student, stat : ${studentProfiles}">
            <td th:text="${stat.count}"></td>
            <td th:text="${student.firstName}"></td>
            <td th:text="${student.lastName}"></td>
            <td th:text="${student.dob}"></td>
            <td th:text="${student.gender ? 'Nam' : 'Nữ'}"></td>
            <td th:text="${student.address}"></td>
            <td th:text="${student.phoneNumber}"></td>
            <td th:text="${student.email}"></td>
            <td th:text="${student.parent.parentName}"></td>
            <td th:text="${student.parent.parentPhone}"></td>
            <td th:text="${student.parent.parentEmail}"></td>
            <th:block th:if="${student.major != null}">
              <td th:text="${student.major.majorID}"></td>
            </th:block>
            <th:block th:unless="${student.major != null}">
              <td>No Major Available</td>
            </th:block>
            <td th:text="${student.yearOfAdmission}"></td>
            <td th:text="${student.parent.relationship}"></td>
            <td th:text="${student.schoolYear}"></td>
            <td th:text="${student.studentID}"></td>
          </tr>
        </tbody>
      </table>
      <div id="paginationControls">
        <button onclick="prevPage()">Trang trước</button>
        <span id="pageIndicator">1</span>
        <button onclick="nextPage()">Trang sau</button>
      </div>
    </div>

    <!-- Modal HTML -->
    <div id="successModal" class="modal">
      <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <p>Dữ liệu đã được lưu thành công!</p>
        <button onclick="window.location.href='/'">Quay về trang chủ</button>
      </div>
    </div>

    <form
      th:if="${fileUploaded}"
      id="saveDataForm"
      method="post"
      th:action="@{/submitUploadStudentAccount}"
    >
      <button type="button" onclick="submitData()">Lưu dữ liệu vào DB</button>
    </form>

    <script>
      function submitData() {
        fetch("/submitUploadStudentAccount", {
          method: "POST",
        })
          .then((response) => response.text())
          .then((data) => {
            // Hiển thị modal khi nhận được phản hồi thành công
            const modal = document.getElementById("successModal");
            modal.style.display = "flex";
          });
      }

      // Đóng modal khi nhấn vào dấu 'x'
      document.getElementById("closeModal").onclick = function () {
        document.getElementById("successModal").style.display = "none";
      };

      // Đóng modal khi nhấn ra ngoài
      window.onclick = function (event) {
        const modal = document.getElementById("successModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };
    </script>
    <script>
      let currentPage = 1;
      const rowsPerPage = 20;

      function displayPage(page) {
        const tableBody = document.getElementById("studentTableBody");
        const rows = tableBody.querySelectorAll("tr");

        // Tính toán trang hiện tại
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        // Ẩn tất cả các hàng
        rows.forEach((row, index) => {
          row.style.display = index >= start && index < end ? "" : "none";
        });

        // Cập nhật chỉ số trang
        document.getElementById("pageIndicator").textContent = page;
      }

      function nextPage() {
        const tableBody = document.getElementById("studentTableBody");
        const rows = tableBody.querySelectorAll("tr");

        if (currentPage * rowsPerPage < rows.length) {
          currentPage++;
          displayPage(currentPage);
        }
      }

      function prevPage() {
        if (currentPage > 1) {
          currentPage--;
          displayPage(currentPage);
        }
      }

      // Khởi tạo hiển thị trang đầu tiên
      document.addEventListener("DOMContentLoaded", () => {
        displayPage(currentPage);
      });
    </script>
  </body>
</html>
